name: Build .deb

on:
  workflow_dispatch:
  push:
    tags: ['v*']

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        run: |
          VER=$(python3 -c "import re; print(re.search(r'version\s*=\s*\"([^\"]+)\"', open('pyproject.toml').read()).group(1))")
          echo "VER=$VER" >> $GITHUB_ENV

      - name: Build .deb
        run: |
          PKG=linguaedit
          VER=${{ env.VER }}
          DEB="${PKG}_${VER}-1_all.deb"
          DEST="deb-root"

          mkdir -p $DEST/DEBIAN
          mkdir -p $DEST/usr/lib/python3/dist-packages/linguaedit
          mkdir -p $DEST/usr/bin
          mkdir -p $DEST/usr/share/applications
          mkdir -p $DEST/usr/share/icons/hicolor/128x128/apps
          mkdir -p $DEST/usr/share/metainfo

          cp src/linguaedit/*.py $DEST/usr/lib/python3/dist-packages/linguaedit/
          cp -r resources $DEST/usr/lib/python3/dist-packages/linguaedit/ 2>/dev/null || true
          cp -r ui $DEST/usr/lib/python3/dist-packages/linguaedit/ 2>/dev/null || true

          cat > $DEST/usr/bin/linguaedit << 'LAUNCHER'
          #!/usr/bin/env python3
          from linguaedit.app import main
          main()
          LAUNCHER
          chmod +x $DEST/usr/bin/linguaedit
          sed -i 's/^          //' $DEST/usr/bin/linguaedit

          cp io.github.yeager.linguaedit.desktop $DEST/usr/share/applications/ 2>/dev/null || true
          cp data/icons/linguaedit.png $DEST/usr/share/icons/hicolor/128x128/apps/ 2>/dev/null || true
          cp io.github.yeager.linguaedit.metainfo.xml $DEST/usr/share/metainfo/ 2>/dev/null || true

          cat > $DEST/DEBIAN/control << CTRL
          Package: linguaedit
          Version: ${VER}-1
          Section: devel
          Priority: optional
          Architecture: all
          Depends: python3, python3-pyside6.qtwidgets, python3-polib, python3-yaml, python3-requests
          Maintainer: Daniel Nylander <daniel@danielnylander.se>
          Description: Qt6/PySide6 translation file editor
           A powerful translation file editor supporting PO, TS, JSON, XLIFF,
           Android, ARB, PHP, and YAML formats.
          CTRL
          sed -i 's/^          //' $DEST/DEBIAN/control

          dpkg-deb --build $DEST "$DEB"
          echo "Built $DEB"

      - uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: "*.deb"

      - name: Upload .deb to release
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VER=${{ env.VER }}
          DEB="linguaedit_${VER}-1_all.deb"
          gh release upload "v${VER}" "$DEB" --clobber 2>/dev/null || true
