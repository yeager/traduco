name: Build LinguaEdit

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: pip install pyinstaller PySide6 polib requests PyYAML
      - name: Compile translations (skip empty)
        run: |
          rm -f src/linguaedit/translations/linguaedit_*.qm src/linguaedit/translations/linguaedit.qm
          for ts in src/linguaedit/translations/linguaedit_*.ts; do
            [ -f "$ts" ] || continue
            case "$ts" in *template*) continue;; esac
            pyside6-lrelease "$ts"
            qm="${ts%.ts}.qm"
            if [ -f "$qm" ] && [ "$(stat -f%z "$qm")" -lt 20480 ]; then rm "$qm"; fi
          done
      - name: Build .app
        run: |
          pyinstaller --windowed --name LinguaEdit \
            --add-data "src/linguaedit/translations:linguaedit/translations" \
            --add-data "resources/flags:resources/flags" \
            --hidden-import=linguaedit \
            --exclude-module=enchant \
            --paths=src src/linguaedit/app.py
      - name: Register file types
        run: |
          plutil -insert CFBundleDocumentTypes -json '[{"CFBundleTypeName":"PO File","CFBundleTypeExtensions":["po","pot"],"CFBundleTypeRole":"Editor"},{"CFBundleTypeName":"Qt TS File","CFBundleTypeExtensions":["ts"],"CFBundleTypeRole":"Editor"},{"CFBundleTypeName":"XLIFF File","CFBundleTypeExtensions":["xliff","xlf"],"CFBundleTypeRole":"Editor"},{"CFBundleTypeName":"ARB File","CFBundleTypeExtensions":["arb"],"CFBundleTypeRole":"Editor"}]' dist/LinguaEdit.app/Contents/Info.plist
      - name: Create zip
        run: |
          cd dist && zip -r ../LinguaEdit-${{ github.ref_name }}-macOS.zip LinguaEdit.app
      - uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: LinguaEdit-${{ github.ref_name }}-macOS.zip

  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install deps
        run: |
          pip install pyinstaller PySide6 polib requests PyYAML Pillow
      - name: Compile translations (skip empty)
        shell: bash
        run: |
          # Remove any stale .qm files first
          rm -f src/linguaedit/translations/linguaedit_*.qm src/linguaedit/translations/linguaedit.qm
          for ts in src/linguaedit/translations/linguaedit_*.ts; do
            [ -f "$ts" ] || continue
            case "$ts" in *template*) continue;; esac
            pyside6-lrelease "$ts"
            qm="${ts%.ts}.qm"
            # Remove small .qm files (< 20 KB = no real translations)
            if [ -f "$qm" ]; then
              size=$(wc -c < "$qm")
              if [ "$size" -lt 20480 ]; then
                rm "$qm"
              fi
            fi
          done
          echo "Compiled .qm files:"
          ls -lh src/linguaedit/translations/*.qm 2>/dev/null || echo "none"
      - name: Create .ico
        run: |
          python -c "from PIL import Image; img=Image.open('resources/icon.png'); img.save('resources/icon.ico', sizes=[(16,16),(32,32),(48,48),(64,64),(128,128),(256,256)])"
      - name: Build .exe
        run: |
          pyinstaller --windowed --name LinguaEdit `
            --icon resources/icon.ico `
            --add-data "src/linguaedit/translations;linguaedit/translations" `
            --add-data "resources/flags;resources/flags" `
            --hidden-import=linguaedit `
            --exclude-module=enchant `
            --paths=src src/linguaedit/app.py
      - name: Build installer
        run: |
          $version = "${{ github.ref_name }}".TrimStart("v")
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /DMyAppVersion=$version installer\linguaedit.iss
      - uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: LinguaEdit-*-Setup.exe

  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install PySide6 for lrelease
        run: pip install PySide6
      - name: Compile translations (skip empty)
        run: |
          rm -f src/linguaedit/translations/linguaedit_*.qm src/linguaedit/translations/linguaedit.qm
          for ts in src/linguaedit/translations/linguaedit_*.ts; do
            [ -f "$ts" ] || continue
            case "$ts" in *template*) continue;; esac
            pyside6-lrelease "$ts"
            qm="${ts%.ts}.qm"
            if [ -f "$qm" ] && [ "$(stat --format=%s "$qm" 2>/dev/null || stat -f%z "$qm")" -lt 20480 ]; then rm "$qm"; fi
          done
      - name: Build .deb
        run: python3 .github/scripts/build_deb.py ${GITHUB_REF_NAME#v}
      - uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: linguaedit_*_all.deb

  release:
    needs: [macos, windows, linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true
      - name: List files
        run: ls -la
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            LinguaEdit-*-macOS.zip
            LinguaEdit-*-Setup.exe
            linguaedit_*_all.deb
          overwrite_files: true
